<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Call - VCall</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      overflow: hidden;
      border-radius: 24px;
    }

    video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 24px;
    }

    #localVideo {
      transform: scaleX(-1); /* ðŸ‘ˆ Mirror local video */
    }

    video.small {
      width: 120px;
      height: 160px;
      right: 16px;
      top: 16px;
      z-index: 2;
      border-radius: 12px;
    }

    #callingText {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      z-index: 10;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    #controls {
      position: absolute;
      bottom: 30px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 5;
    }

    .btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #1f1f1f;
      color: white;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .btn svg {
      width: 28px;
      height: 28px;
    }

    .btn:hover {
      background-color: #333;
      transform: scale(1.05);
    }

    .btn:active {
      transform: scale(0.95);
      opacity: 0.8;
    }

    .btn.end {
      background-color: #e53935;
    }

    .btn.end:hover {
      background-color: #d32f2f;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <div id="callingText">Calling...</div>

  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div id="controls">
    <!-- Speaker Button -->
    <button class="btn" id="speakerBtn" onclick="toggleSpeaker()">
      <svg id="speakerOn" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M7 10v4h4l5 5V5l-5 5H7z"/></svg>
      <svg id="speakerOff" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-.77-3.29-2-4.3v8.6c1.23-1.01 2-2.53 2-4.3zM4.27 3L3 4.27 7.73 9H3v6h4l5 5V13.73l4.73 4.73L21 19.73 4.27 3z"/></svg>
    </button>

    <!-- Mute Button -->
    <button class="btn" id="muteBtn" onclick="toggleMute()">
      <svg id="micOn" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5a3 3 0 00-6 0v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
      <svg id="micOff" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M15 10.89V5a3 3 0 00-6 0v1.89l6 6zM4.27 3L3 4.27l5 5V11c0 1.66 1.34 3 3 3 .54 0 1.05-.15 1.5-.4l1.13 1.13c-.79.44-1.68.69-2.63.69-2.76 0-5-2.24-5-5H2c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c1.19-.17 2.26-.64 3.13-1.31L19.73 21 21 19.73 4.27 3z"/></svg>
    </button>

    <!-- End Call Button -->
    <button class="btn end" onclick="endCall()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M21 15.46l-5.27-.61a11.72 11.72 0 00-7.46 0L3 15.46V18h18v-2.54z"/></svg>
    </button>
  </div>

  <script>
    let localStream = null, remoteStream = null, currentCall = null;
    let isMuted = false, speakerEnabled = true;

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const callingText = document.getElementById("callingText");

    const micOn = document.getElementById("micOn");
    const micOff = document.getElementById("micOff");
    const speakerOn = document.getElementById("speakerOn");
    const speakerOff = document.getElementById("speakerOff");

    document.addEventListener("DOMContentLoaded", () => {
      let tries = 0;
      function tryInit() {
        if (!window.opener || !window.opener.localStream || !window.opener.currentCall) {
          if (tries++ < 10) return setTimeout(tryInit, 300);
          alert("Video streams not available");
          return;
        }

        localStream = window.opener.localStream;
        currentCall = window.opener.currentCall;

        localVideo.srcObject = localStream;
        localVideo.play();

        if (window.opener.remoteStream) {
          remoteStream = window.opener.remoteStream;
          remoteVideo.srcObject = remoteStream;
          remoteVideo.play();
          callingText.style.display = "none";
        } else {
          currentCall.on("stream", remote => {
            remoteStream = remote;
            remoteVideo.srcObject = remote;
            remoteVideo.play();
            callingText.style.display = "none";
          });
        }

        toggleView(true);
      }
      tryInit();
    });

    localVideo.addEventListener("click", () => toggleView(true));
    remoteVideo.addEventListener("click", () => toggleView(false));

    function toggleView(showLocalFull) {
      if (showLocalFull) {
        localVideo.classList.remove("small");
        remoteVideo.classList.add("small");
      } else {
        remoteVideo.classList.remove("small");
        localVideo.classList.add("small");
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
      micOn.classList.toggle("hidden", isMuted);
      micOff.classList.toggle("hidden", !isMuted);
    }

    function toggleSpeaker() {
      speakerEnabled = !speakerEnabled;
      remoteVideo.muted = !speakerEnabled;
      speakerOn.classList.toggle("hidden", !speakerEnabled);
      speakerOff.classList.toggle("hidden", speakerEnabled);
    }

    function endCall() {
      if (currentCall) currentCall.close();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      window.close();
    }
  </script>
</body>
</html>
