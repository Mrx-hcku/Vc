<!DOCTYPE html>
<html>
<head>
  <title>Call - VCall</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #000;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
    }
    video {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #remoteVideo.small, #localVideo.small {
      width: 120px;
      height: 160px;
      right: 16px;
      top: 16px;
      z-index: 2;
      border-radius: 12px;
    }
    #callingText {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      z-index: 10;
      animation: pulse 1.5s infinite;
      background: rgba(0, 0, 0, 0.4);
      padding: 10px 20px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
    }
    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }
    #switchCamera {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 3;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    #switchCamera svg {
      width: 22px;
      height: 22px;
      fill: white;
    }
    #switchCamera:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    #controls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      z-index: 3;
    }
    #controls > div {
      display: flex;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 16px;
      border-radius: 32px;
      gap: 14px;
      backdrop-filter: blur(10px);
    }
    .btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      border: none;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s ease;
    }
    .btn svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
    .btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    .btn.end {
      background: #e53935;
    }
    .btn.end:hover {
      background: #ff4e4e;
    }
  </style>
</head>
<body>

<div id="callingText">Calling...</div>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<!-- Switch Camera -->
<button id="switchCamera" title="Switch Camera">
  <svg viewBox="0 0 24 24">
    <path d="M20 4h-3.17l-1.84-2H9.01L7.17 4H4c-1.1 0-2 .9-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6c0-1.1-.9-2-2-2zM12 17a5 5 0 110-10 5 5 0 010 10z"/>
  </svg>
</button>

<!-- Bottom controls -->
<div id="controls">
  <div>
    <!-- Speaker -->
    <button class="btn" onclick="toggleSpeaker()" title="Speaker">
      <svg viewBox="0 0 24 24"><path d="M7 9v6h4l5 5V4l-5 5H7z"/></svg>
    </button>

    <!-- Mute -->
    <button class="btn" onclick="toggleMute()" title="Mute">
      <svg viewBox="0 0 24 24">
        <path d="M19 11c0 1.93-1.17 3.57-2.83 4.3l1.45 1.45C19.07 15.74 20 13.49 20 11h-1zm-7 8c1.73 0 3.29-.55 4.58-1.49L15 16.41A6.96 6.96 0 0112 17a7 7 0 01-7-7H4c0 2.49 1.02 4.74 2.67 6.34L3.41 20.59 4.83 22l18-18-1.41-1.41L16.76 6.6C16.9 6.38 17 6.14 17 6V4h-2v2c0 .28-.22.5-.5.5S14 6.28 14 6V4h-4v2c0 .28-.22.5-.5.5S9 6.28 9 6V4H7v2c0 .14.05.27.14.37L5.41 5.59 4 7l6 6v1c0 .55.45 1 1 1s1-.45 1-1v-1.17l6.31 6.31C15.3 19.47 13.72 20 12 20z"/>
      </svg>
    </button>

    <!-- End Call -->
    <button class="btn end" onclick="endCall()" title="End Call">
      <svg viewBox="0 0 24 24"><path d="M21 7.5l-5.5 5.5 5.5 5.5-1.5 1.5-5.5-5.5-5.5 5.5-1.5-1.5 5.5-5.5-5.5-5.5L9 6l5.5 5.5L20 6z"/></svg>
    </button>
  </div>
</div>

<script>
let localStream = null, remoteStream = null, currentCall = null;
let isMuted = false, speakerEnabled = true;
let isUsingFrontCamera = false;

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const callingText = document.getElementById("callingText");

// Initial camera: back
const getStream = (facing) => {
  return navigator.mediaDevices.getUserMedia({
    video: { facingMode: { exact: facing } },
    audio: true
  });
};

document.addEventListener("DOMContentLoaded", () => {
  let tries = 0;
  function tryInit() {
    if (!window.opener || !window.opener.currentCall) {
      if (tries++ < 10) return setTimeout(tryInit, 300);
      alert("Video streams not available");
      return;
    }

    currentCall = window.opener.currentCall;

    getStream("environment").then(stream => {
      localStream = stream;
      localVideo.srcObject = stream;
      window.opener.localStream = stream;

      if (window.opener.remoteStream) {
        remoteStream = window.opener.remoteStream;
        remoteVideo.srcObject = remoteStream;
        callingText.style.display = "none";
      } else {
        currentCall.on("stream", remote => {
          remoteStream = remote;
          remoteVideo.srcObject = remote;
          callingText.style.display = "none";
        });
      }

      toggleView(true);
    }).catch(err => {
      alert("Camera access failed: " + err.message);
    });
  }

  tryInit();
});

localVideo.addEventListener("click", () => toggleView(true));
remoteVideo.addEventListener("click", () => toggleView(false));

function toggleView(showLocalFull) {
  if (showLocalFull) {
    localVideo.classList.remove("small");
    remoteVideo.classList.add("small");
  } else {
    remoteVideo.classList.remove("small");
    localVideo.classList.add("small");
  }
}

function toggleMute() {
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
}

function toggleSpeaker() {
  speakerEnabled = !speakerEnabled;
  remoteVideo.muted = !speakerEnabled;
}

function endCall() {
  if (currentCall) currentCall.close();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  window.close();
}

// Switch front/back camera
document.getElementById("switchCamera").onclick = () => {
  isUsingFrontCamera = !isUsingFrontCamera;
  const facingMode = isUsingFrontCamera ? "user" : "environment";

  getStream(facingMode).then(stream => {
    const newTrack = stream.getVideoTracks()[0];
    const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === "video");

    if (sender) sender.replaceTrack(newTrack);

    localStream.getTracks().forEach(t => t.stop());
    localStream = stream;
    localVideo.srcObject = stream;
  }).catch(err => {
    alert("Switch camera failed: " + err.message);
  });
};
</script>

</body>
  </html>
