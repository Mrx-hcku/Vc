<!DOCTYPE html>
<html>
<head>
  <title>Video Call App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      padding: 0 16px;
    }
    header {
      background: #0a84ff;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    h3 { margin-top: 24px; }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
      border-radius: 8px;
      border: none;
    }
    button {
      background: #0a84ff;
      color: white;
      font-weight: bold;
    }
    ul { list-style: none; padding: 0; }
    li {
      background: #1e1e1e;
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }
    #incoming {
      background: #222;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>
  <header>Video Call App</header>

  <input type="text" id="searchBox" placeholder="Search users..." oninput="filterUsers()">

  <h3>Online Users</h3>
  <ul id="users"></ul>

  <h3>Recent Calls</h3>
  <ul id="recent"></ul>

  <div id="incoming">
    <p id="callFrom"></p>
    <button onclick="acceptCall()">Accept</button>
    <button onclick="rejectCall()">Reject</button>
  </div>

  <audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" loop></audio>

  <!-- Firebase & PeerJS -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDxTN6oRxNKUAJ0eVUZucumAALeBBG72hk",
      authDomain: "vcall-5f220.firebaseapp.com",
      databaseURL: "https://vcall-5f220-default-rtdb.firebaseio.com",
      projectId: "vcall-5f220",
      storageBucket: "vcall-5f220.appspot.com",
      messagingSenderId: "679349443110",
      appId: "1:679349443110:web:b44818bb14dffafcec24e7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const ringtone = document.getElementById("ringtone");
    const usersEl = document.getElementById("users");
    const recentEl = document.getElementById("recent");
    const searchBox = document.getElementById("searchBox");
    const incomingEl = document.getElementById("incoming");
    const callFromEl = document.getElementById("callFrom");

    let username = "";
    let peer = null;
    let localStream = null;
    let currentCall = null;

    window.onload = () => {
      if (localStorage.getItem("loggedIn") !== "true") {
        location.href = "auth.html";
        return;
      }

      auth.onAuthStateChanged(user => {
        if (user) {
          username = user.email.split("@")[0];
          initApp();
        } else {
          location.href = "auth.html";
        }
      });
    };

    function initApp() {
      peer = new Peer(username, { host: "0.peerjs.com", port: 443, secure: true });

      peer.on("open", () => {
        db.ref("users/" + username).set(true);
        db.ref("users/" + username).onDisconnect().remove();
        loadUsers();
        loadRecent();

        db.ref("calls/" + username).on("value", snap => {
          if (snap.exists()) {
            const caller = snap.val().from;
            callFromEl.textContent = `Incoming call from ${caller}`;
            incomingEl.style.display = "block";
            ringtone.play().catch(() => {});
          }
        });
      });

      peer.on("call", call => {
        window.pendingCall = call;
      });

      setInterval(() => {
        loadUsers();
        loadRecent();
      }, 5000);
    }

    function loadUsers() {
      db.ref("users").once("value", snap => {
        usersEl.innerHTML = "";
        snap.forEach(child => {
          const user = child.key;
          if (user !== username) {
            const li = document.createElement("li");
            li.innerHTML = `
              <span><img class="avatar" src="https://ui-avatars.com/api/?name=${user}"> ${user}</span>
              <button onclick="startCall('${user}')">ðŸ“ž</button>`;
            usersEl.appendChild(li);
          }
        });
      });
    }

    function loadRecent() {
      db.ref("recent/" + username).once("value", snap => {
        recentEl.innerHTML = "";
        snap.forEach(child => {
          const name = child.key;
          const li = document.createElement("li");
          li.innerHTML = `
            <span><img class="avatar" src="https://ui-avatars.com/api/?name=${name}"> ${name}</span>
            <button onclick="startCall('${name}')">ðŸ“ž</button>`;
          recentEl.appendChild(li);
        });
      });
    }

    function filterUsers() {
      const val = searchBox.value.toLowerCase();
      [...usersEl.children].forEach(li => {
        const name = li.textContent.toLowerCase();
        li.style.display = name.includes(val) ? "flex" : "none";
      });
    }

    function requestMedia() {
      return navigator.mediaDevices.getUserMedia({
        video: true,
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: false
        }
      });
    }

    function startCall(target) {
      db.ref("recent/" + username + "/" + target).set(true);
      requestMedia().then(stream => {
        localStream = stream;
        const call = peer.call(target, stream);

        call.on("stream", remote => {
          window.localStream = stream;
          window.remoteStream = remote;
          window.currentCall = call;
          window.open("call.html", "_blank", "fullscreen=yes");
        });

        currentCall = call;
      });
    }

    function acceptCall() {
      ringtone.pause(); ringtone.currentTime = 0;
      incomingEl.style.display = "none";

      requestMedia().then(stream => {
        localStream = stream;
        window.pendingCall.answer(stream);

        window.pendingCall.on("stream", remote => {
          window.localStream = stream;
          window.remoteStream = remote;
          window.currentCall = window.pendingCall;
          window.open("call.html", "_blank", "fullscreen=yes");
        });

        db.ref("calls/" + username).remove();
      });
    }

    function rejectCall() {
      ringtone.pause(); ringtone.currentTime = 0;
      incomingEl.style.display = "none";
      db.ref("calls/" + username).remove();
    }
  </script>
</body>
</html>
