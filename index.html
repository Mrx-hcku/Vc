<!DOCTYPE html>
<html>
<head>
  <title>Video Call App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #0b141a;
      color: #e4e6eb;
      font-family: "Segoe UI", sans-serif;
      margin: 0; padding: 0;
    }
    h2, h3 {
      text-align: center;
      margin: 12px 0;
    }
    .hidden { display: none; }
    input, button {
      padding: 12px;
      margin: 8px auto;
      width: 90%; max-width: 300px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      display: block;
    }
    input {
      background: #1e2a33;
      color: white;
    }
    button {
      background: #128c7e;
      color: white;
      font-weight: bold;
    }
    ul { list-style: none; padding: 0 16px; }
    li {
      background: #1e2a33;
      margin: 10px 0;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      border-radius: 12px;
      align-items: center;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    video {
      width: 100%;
      max-height: 45vh;
      background: #000;
      border-radius: 10px;
      margin-top: 10px;
    }
    #controls button {
      width: 32%;
      margin: 6px 1%;
    }
    #ringtone { display: none; }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginView">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button onclick="signup()">Sign Up</button>
  <p id="authMsg" style="text-align:center;color:red;"></p>
</div>

<!-- Home Screen -->
<div id="homeView" class="hidden">
  <h2 id="welcomeTitle"></h2>
  <input type="text" id="searchInput" placeholder="Search user..." oninput="filterUsers()">
  <h3>Online Users</h3>
  <ul id="usersList"></ul>
  <h3>Recent Calls</h3>
  <ul id="recentList"></ul>
</div>

<!-- Call Screen -->
<div id="callView" class="hidden">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay playsinline muted></video>
  <div id="controls">
    <button onclick="toggleMute()">Mute</button>
    <button onclick="toggleSpeaker()">Speaker</button>
    <button onclick="endCall()">End</button>
  </div>
</div>

<!-- Incoming Call -->
<div id="incomingView" class="hidden">
  <h3 id="incomingCaller"></h3>
  <button onclick="acceptCall()">Accept</button>
  <button onclick="rejectCall()">Reject</button>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" loop autoplay></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDxTN6oRxNKUAJ0eVUZucumAALeBBG72hk",
    authDomain: "vcall-5f220.firebaseapp.com",
    databaseURL: "https://vcall-5f220-default-rtdb.firebaseio.com",
    projectId: "vcall-5f220",
    storageBucket: "vcall-5f220.appspot.com",
    messagingSenderId: "679349443110",
    appId: "1:679349443110:web:b44818bb14dffafcec24e7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const ringtone = document.getElementById("ringtone");

  let username = "", peer = null, localStream = null, currentCall = null;
  let muted = false, speakerEnabled = true;

  window.onload = () => {
    auth.onAuthStateChanged(user => {
      if (user) startApp(user);
    });
  };

  function login() {
    const email = emailEl().value, pass = passwordEl().value;
    auth.signInWithEmailAndPassword(email, pass).then(cred => {
      startApp(cred.user);
    }).catch(e => authMsg().innerText = e.message);
  }

  function signup() {
    const email = emailEl().value, pass = passwordEl().value;
    auth.createUserWithEmailAndPassword(email, pass).then(cred => {
      startApp(cred.user);
    }).catch(e => authMsg().innerText = e.message);
  }

  function startApp(user) {
    username = user.email.split('@')[0];
    loginView().classList.add("hidden");
    homeView().classList.remove("hidden");
    welcomeTitle().innerText = `Welcome, ${username}`;

    peer = new Peer(username, { host: '0.peerjs.com', port: 443, secure: true });

    peer.on('open', () => {
      db.ref("users/" + username).set(true);
      db.ref("users/" + username).onDisconnect().remove();

      refreshLists();
      setInterval(refreshLists, 5000); // Auto-refresh

      db.ref("calls/" + username).on("value", snap => {
        if (snap.exists()) {
          ringtone.play().catch(() => {});
          const caller = snap.val().from;
          incomingCaller().innerText = `Call from ${caller}`;
          incomingView().classList.remove("hidden");
          window.pendingCaller = caller;
        }
      });
    });

    peer.on('call', call => {
      window.pendingCall = call;
    });
  }

  function refreshLists() {
    loadUsers();
    loadRecents();
  }

  function loadUsers() {
    db.ref("users").once("value").then(snap => {
      const ul = usersList();
      ul.innerHTML = "";
      snap.forEach(child => {
        const user = child.key;
        if (user !== username) {
          const li = document.createElement("li");
          li.innerHTML = `
            <div class="user-info">
              <img class="avatar" src="https://ui-avatars.com/api/?name=${user}">${user}
            </div>
            <button onclick="callUser('${user}')">Call</button>`;
          ul.appendChild(li);
        }
      });
    });
  }

  function loadRecents() {
    db.ref("recents/" + username).once("value").then(snap => {
      const ul = recentList();
      ul.innerHTML = "";
      snap.forEach(child => {
        const user = child.key;
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="user-info">
            <img class="avatar" src="https://ui-avatars.com/api/?name=${user}">${user}
          </div>
          <button onclick="callUser('${user}')">Call</button>`;
        ul.appendChild(li);
      });
    });
  }

  function callUser(target) {
    requestMedia().then(stream => {
      localStream = stream;
      db.ref("calls/" + target).set({ from: username });
      const call = peer.call(target, stream);
      currentCall = call;
      setupCallHandlers(call);
      showVideoUI();
      saveRecent(target);
    });
  }

  function acceptCall() {
    ringtone.pause(); ringtone.currentTime = 0;
    incomingView().classList.add("hidden");
    requestMedia().then(stream => {
      localStream = stream;
      window.pendingCall.answer(stream);
      currentCall = window.pendingCall;
      setupCallHandlers(currentCall);
      showVideoUI();
      db.ref("calls/" + username).remove();
      saveRecent(window.pendingCaller);
    });
  }

  function rejectCall() {
    ringtone.pause(); ringtone.currentTime = 0;
    incomingView().classList.add("hidden");
    db.ref("calls/" + username).remove();
  }

  function setupCallHandlers(call) {
    showVideo(localStream, 'localVideo');
    call.on('stream', remote => showVideo(remote, 'remoteVideo'));
  }

  function showVideoUI() {
    homeView().classList.add("hidden");
    callView().classList.remove("hidden");
  }

  function endCall() {
    if (currentCall) currentCall.close();
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    callView().classList.add("hidden");
    homeView().classList.remove("hidden");
    document.getElementById("remoteVideo").srcObject = null;
    document.getElementById("localVideo").srcObject = null;
  }

  function toggleMute() {
    if (localStream) {
      const track = localStream.getAudioTracks()[0];
      track.enabled = !track.enabled;
    }
  }

  function toggleSpeaker() {
    const remote = document.getElementById("remoteVideo");
    remote.muted = !remote.muted;
  }

  function showVideo(stream, id) {
    const v = document.getElementById(id);
    v.srcObject = stream;
    v.play();
  }

  function saveRecent(user) {
    db.ref("recents/" + username + "/" + user).set(true);
  }

  function filterUsers() {
    const q = document.getElementById("searchInput").value.toLowerCase();
    [...usersList().children].forEach(li => {
      li.style.display = li.textContent.toLowerCase().includes(q) ? "flex" : "none";
    });
  }

  // Element shortcuts
  const emailEl = () => document.getElementById("email");
  const passwordEl = () => document.getElementById("password");
  const authMsg = () => document.getElementById("authMsg");
  const loginView = () => document.getElementById("loginView");
  const homeView = () => document.getElementById("homeView");
  const callView = () => document.getElementById("callView");
  const incomingView = () => document.getElementById("incomingView");
  const incomingCaller = () => document.getElementById("incomingCaller");
  const welcomeTitle = () => document.getElementById("welcomeTitle");
  const usersList = () => document.getElementById("usersList");
  const recentList = () => document.getElementById("recentList");
</script>

</body>
  </html>
